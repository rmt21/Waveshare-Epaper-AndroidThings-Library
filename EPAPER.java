package vitalinstinct.housecontrolepaper;

import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Matrix;
import android.graphics.Paint;
import android.graphics.Typeface;
import android.media.Image;
import android.util.Log;

import com.google.android.things.pio.Gpio;
import com.google.android.things.pio.PeripheralManagerService;
import com.google.android.things.pio.SpiDevice;

import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.IntBuffer;
import java.nio.charset.StandardCharsets;
import java.util.List;

import static android.graphics.Paint.ANTI_ALIAS_FLAG;

/*
 * Created by Reece on 28/08/2017, vitalinstinct.housecontrolepaper, HouseControlEPAPER
 */

public class EPAPER {

    private static int xDot = 128;
    private static int yDot = 296;
    private static long DELAYTIME = 5;
    private static int SPI_MAX_SPEED = 2000000;

    private static int rst = 17;
    private static int dc= 25;
    private static int busy = 24;
    private static int cs = 8;

    private static Gpio RST, DC, BUSY, CS;
    SpiDevice device;
    PeripheralManagerService service;

    Paint paint;
    Bitmap preImage, image;
    Canvas canvas;
    Matrix matrix;

    private final static byte[] LUTDefault_full = new byte[] {(byte)0x32,(byte)0x02,(byte)0x02,(byte)0x01,(byte)0x11,(byte)0x12,(byte)0x12,(byte)0x22,(byte)0x22,(byte)0x66,(byte)0x69,(byte)0x69,(byte)0x59,(byte)0x58,(byte)0x99,(byte)0x99,(byte)0x88,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0xF8,(byte)0xB4,(byte)0x13,(byte)0x51,(byte)0x35,(byte)0x51,(byte)0x51,(byte)0x19,(byte)0x01,(byte)0x00};
    private final static byte[] LUTDefault_part = new byte[] {(byte)0x32,(byte)0x10,(byte)0x18,(byte)0x18,(byte)0x08,(byte)0x18,(byte)0x18,(byte)0x08,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x13,(byte)0x14,(byte)0x44,(byte)0x12,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00,(byte)0x00};
    private final static byte[] GDOControl = new byte[] {(byte)0x01,(byte)((yDot-1)%256),(byte)((yDot-1)/256),(byte)0x00};
    private final static byte[] softstart = new byte[] {(byte)0x0c,(byte)0xd7,(byte)0xd6,(byte)0x9d};
    private final static byte[] VCOMVol = new byte[] {(byte)0x2c, (byte)0xa8};
    private final static byte[] DummyLine = new byte[] {(byte)0x3a, (byte)0x1a};
    private final static byte[] Gatetime = new byte[] {(byte)0x3b,(byte) 0x08};
    private final static byte[] RamDataEntryMode = new byte[] {(byte)0x11, (byte)0x01};


    private static byte[][] Font1206 = new byte[][]{
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//" ",0%/
            {0x00, 0x00, 0x00, 0x00, 0x3F, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"!",1%/
            {0x00, 0x00, 0x30, 0x00, 0x40, 0x00, 0x30, 0x00, 0x40, 0x00, 0x00, 0x00},//""",2%/
            {0x09, 0x00, 0x0B, (byte)0xC0, 0x3D, 0x00, 0x0B, (byte)0xC0, 0x3D, 0x00, 0x09, 0x00},//"//",3%/
            {0x18, (byte)0xC0, 0x24, 0x40, 0x7F, (byte)0xE0, 0x22, 0x40, 0x31, (byte)0x80, 0x00, 0x00},//"$",4%/
            {0x18, 0x00, 0x24, (byte)0xC0, 0x1B, 0x00, 0x0D, (byte)0x80, 0x32, 0x40, 0x01, (byte)0x80},//"%",5%/
            {0x03, (byte)0x80, 0x1C, 0x40, 0x27, 0x40, 0x1C, (byte)0x80, 0x07, 0x40, 0x00, 0x40},//"&",6%/
            {0x10, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"'",7%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, (byte)0x80, 0x20, 0x40, 0x40, 0x20},//"(",8%/
            {0x00, 0x00, 0x40, 0x20, 0x20, 0x40, 0x1F, (byte)0x80, 0x00, 0x00, 0x00, 0x00},//")",9%/
            {0x09, 0x00, 0x06, 0x00, 0x1F, (byte)0x80, 0x06, 0x00, 0x09, 0x00, 0x00, 0x00},//"%",10%/
            {0x04, 0x00, 0x04, 0x00, 0x3F, (byte)0x80, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00},//"+",11%/
            {0x00, 0x10, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//",",12%/
            {0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00},//"-",13%/
            {0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//".",14%/
            {0x00, 0x20, 0x01, (byte)0xC0, 0x06, 0x00, 0x38, 0x00, 0x40, 0x00, 0x00, 0x00},//"/",15%/
            {0x1F, (byte)0x80, 0x20, 0x40, 0x20, 0x40, 0x20, 0x40, 0x1F, (byte)0x80, 0x00, 0x00},//"0",16%/
            {0x00, 0x00, 0x10, 0x40, 0x3F, (byte)0xC0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00},//"1",17%/
            {0x18, (byte)0xC0, 0x21, 0x40, 0x22, 0x40, 0x24, 0x40, 0x18, 0x40, 0x00, 0x00},//"2",18%/
            {0x10, (byte)0x80, 0x20, 0x40, 0x24, 0x40, 0x24, 0x40, 0x1B, (byte)0x80, 0x00, 0x00},//"3",19%/
            {0x02, 0x00, 0x0D, 0x00, 0x11, 0x00, 0x3F, (byte)0xC0, 0x01, 0x40, 0x00, 0x00},//"4",20%/
            {0x3C, (byte)0x80, 0x24, 0x40, 0x24, 0x40, 0x24, 0x40, 0x23, (byte)0x80, 0x00, 0x00},//"5",21%/
            {0x1F, (byte)0x80, 0x24, 0x40, 0x24, 0x40, 0x34, 0x40, 0x03, (byte)0x80, 0x00, 0x00},//"6",22%/
            {0x30, (byte)0x00, 0x20, 0x00, 0x27, (byte)0xC0, 0x38, 0x00, 0x20, 0x00, 0x00, 0x00},//"7",23%/
            {0x1B, (byte)0x80, 0x24, 0x40, 0x24, 0x40, 0x24, 0x40, 0x1B, (byte)0x80, 0x00, 0x00},//"8",24%/
            {0x1C, 0x00, 0x22, (byte)0xC0, 0x22, 0x40, 0x22, 0x40, 0x1F, (byte)0x80, 0x00, 0x00},//"9",25%/
            {0x00, 0x00, 0x00, 0x00, 0x08, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//":",26%/
            {0x00, 0x00, 0x00, 0x00, 0x04, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//";",27%/
            {0x00, 0x00, 0x04, 0x00, 0x0A, 0x00, 0x11, 0x00, 0x20, (byte)0x80, 0x40, 0x40},//"<",28%/
            {0x09, 0x00, 0x09, 0x00, 0x09, 0x00, 0x09, 0x00, 0x09, 0x00, 0x00, 0x00},//"=",29%/
            {0x00, 0x00, 0x40, 0x40, 0x20, (byte)0x80, 0x11, 0x00, 0x0A, 0x00, 0x04, 0x00},//">",30%/
            {0x18, 0x00, 0x20, 0x00, 0x23, 0x40, 0x24, 0x00, 0x18, 0x00, 0x00, 0x00},//"?",31%/
            {0x1F, (byte)0x80, 0x20, 0x40, 0x27, 0x40, 0x29, 0x40, 0x1F, 0x40, 0x00, 0x00},//"@",32%/
            {0x00, 0x40, 0x07, (byte)0xC0, 0x39, 0x00, 0x0F, 0x00, 0x01, (byte)0xC0, 0x00, 0x40},//"A",33%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x24, 0x40, 0x24, 0x40, 0x1B, (byte)0x80, 0x00, 0x00},//"B",34%/
            {0x1F, (byte)0x80, 0x20, 0x40, 0x20, 0x40, 0x20, 0x40, 0x30, (byte)0x80, 0x00, 0x00},//"C",35%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x20, 0x40, 0x20, 0x40, 0x1F, (byte)0x80, 0x00, 0x00},//"D",36%/
            {0x20, 0x40, 0x3F,(byte)0xC0, 0x24, 0x40, 0x2E, 0x40, 0x30, (byte)0xC0, 0x00, 0x00},//"E",37%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x24, 0x40, 0x2E, 0x00, 0x30, 0x00, 0x00, 0x00},//"F",38%/
            {0x0F, 0x00, 0x10, (byte)0x80, 0x20, 0x40, 0x22, 0x40, 0x33, (byte)0x80, 0x02, 0x00},//"G",39%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x04, 0x00, 0x04, 0x00, 0x3F, (byte)0xC0, 0x20, 0x40},//"H",40%/
            {0x20, 0x40, 0x20, 0x40, 0x3F,(byte) 0xC0, 0x20, 0x40, 0x20, 0x40, 0x00, 0x00},//"I",41%/
            {0x00, 0x60, 0x20, 0x20, 0x20, 0x20, 0x3F, (byte)0xC0, 0x20, 0x00, 0x20, 0x00},//"J",42%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x24, 0x40, 0x0B, 0x00, 0x30, (byte)0xC0, 0x20, 0x40},//"K",43%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x20, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, (byte)0xC0},//"L",44%/
            {0x3F, (byte)0xC0, 0x3C, 0x00, 0x03, (byte)0xC0, 0x3C, 0x00, 0x3F, (byte)0xC0, 0x00, 0x00},//"M",45%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x0C, 0x40, 0x23, 0x00, 0x3F, (byte)0xC0, 0x20, 0x00},//"N",46%/
            {0x1F, (byte)0x80, 0x20, 0x40, 0x20, 0x40, 0x20, 0x40, 0x1F, (byte)0x80, 0x00, 0x00},//"O",47%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x24, 0x40, 0x24, 0x00, 0x18, 0x00, 0x00, 0x00},//"P",48%/
            {0x1F, (byte)0x80, 0x21, 0x40, 0x21, 0x40, 0x20, (byte)0xE0, 0x1F, (byte)0xA0, 0x00, 0x00},//"Q",49%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x24, 0x40, 0x26, 0x00, 0x19, (byte)0xC0, 0x00, 0x40},//"R",50%/
            {0x18, (byte)0xC0, 0x24, 0x40, 0x24, 0x40, 0x22, 0x40, 0x31, (byte)0x80, 0x00, 0x00},//"S",51%/
            {0x30, 0x00, 0x20, 0x40, 0x3F, (byte)0xC0, 0x20, 0x40, 0x30, 0x00, 0x00, 0x00},//"T",52%/
            {0x20, 0x00, 0x3F, (byte)0x80, 0x00, 0x40, 0x00, 0x40, 0x3F, (byte)0x80, 0x20, 0x00},//"U",53%/
            {0x20, 0x00, 0x3E, 0x00, 0x01, (byte)0xC0, 0x07, 0x00, 0x38, 0x00, 0x20, 0x00},//"V",54%/
            {0x38, 0x00, 0x07, (byte)0xC0, 0x3C, 0x00, 0x07, (byte)0xC0, 0x38, 0x00, 0x00, 0x00},//"W",55%/
            {0x20, 0x40, 0x39, (byte)0xC0, 0x06, 0x00, 0x39, (byte)0xC0, 0x20, 0x40, 0x00, 0x00},//"X",56%/
            {0x20, 0x00, 0x38, 0x40, 0x07, (byte)0xC0, 0x38, 0x40, 0x20, 0x00, 0x00, 0x00},//"Y",57%/
            {0x30, 0x40, 0x21, (byte)0xC0, 0x26, 0x40, 0x38, 0x40, 0x20, (byte)0xC0, 0x00, 0x00},//"Z",58%/
            {0x00, 0x00, 0x00, 0x00, 0x7F, (byte)0xE0, 0x40, 0x20, 0x40, 0x20, 0x00, 0x00},//"{",59%/
            {0x00, 0x00, 0x70, 0x00, 0x0C, 0x00, 0x03, (byte)0x80, 0x00, 0x40, 0x00, 0x00},//"\",60%/
            {0x00, 0x00, 0x40, 0x20, 0x40, 0x20, 0x7F, (byte)0xE0, 0x00, 0x00, 0x00, 0x00},//"}",61%/
            {0x00, 0x00, 0x20, 0x00, 0x40, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00},//"^",62%/
            {0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10},//"_",63%/
            {0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"`",64%/
            {0x00, 0x00, 0x02, (byte)0x80, 0x05, 0x40, 0x05, 0x40, 0x03, (byte)0xC0, 0x00, 0x40},//"a",65%/
            {0x20, 0x00, 0x3F, (byte)0xC0, 0x04, 0x40, 0x04, 0x40, 0x03,(byte) 0x80, 0x00, 0x00},//"b",66%/
            {0x00, 0x00, 0x03, (byte)0x80, 0x04, 0x40, 0x04, 0x40, 0x06, 0x40, 0x00, 0x00},//"c",67%/
            {0x00, 0x00, 0x03, (byte)0x80, 0x04, 0x40, 0x24, 0x40, 0x3F, (byte)0xC0, 0x00, 0x40},//"d",68%/
            {0x00, 0x00, 0x03, (byte)0x80, 0x05, 0x40, 0x05, 0x40, 0x03, 0x40, 0x00, 0x00},//"e",69%/
            {0x00, 0x00, 0x04, 0x40, 0x1F, (byte)0xC0, 0x24, 0x40, 0x24, 0x40, 0x20, 0x00},//"f",70%/
            {0x00, 0x00, 0x02, (byte)0xE0, 0x05, 0x50, 0x05, 0x50, 0x06, 0x50, 0x04, 0x20},//"g",71%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x04, 0x40, 0x04, 0x00, 0x03,(byte) 0xC0, 0x00, 0x40},//"h",72%/
            {0x00, 0x00, 0x04, 0x40, 0x27, (byte)0xC0, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00},//"i",73%/
            {0x00, 0x10, 0x00, 0x10, 0x04, 0x10, 0x27, (byte)0xE0, 0x00, 0x00, 0x00, 0x00},//"j",74%/
            {0x20, 0x40, 0x3F, (byte)0xC0, 0x01, 0x40, 0x07, 0x00, 0x04, (byte)0xC0, 0x04, 0x40},//"k",75%/
            {0x20, 0x40, 0x20, 0x40, 0x3F, (byte)0xC0, 0x00, 0x40, 0x00, 0x40, 0x00, 0x00},//"l",76%/
            {0x07, (byte)0xC0, 0x04, 0x00, 0x07, (byte)0xC0, 0x04, 0x00, 0x03, (byte)0xC0, 0x00, 0x00},//"m",77%/
            {0x04, 0x40, 0x07,(byte) 0xC0, 0x04, 0x40, 0x04, 0x00, 0x03, (byte)0xC0, 0x00, 0x40},//"n",78%/
            {0x00, 0x00, 0x03,(byte) 0x80, 0x04, 0x40, 0x04, 0x40, 0x03, (byte)0x80, 0x00, 0x00},//"o",79%/
            {0x04, 0x10, 0x07,(byte) 0xF0, 0x04, 0x50, 0x04, 0x40, 0x03, (byte)0x80, 0x00, 0x00},//"p",80%/
            {0x00, 0x00, 0x03,(byte) 0x80, 0x04, 0x40, 0x04, 0x50, 0x07, (byte)0xF0, 0x00, 0x10},//"q",81%/
            {0x04, 0x40, 0x07, (byte)0xC0, 0x02, 0x40, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00},//"r",82%/
            {0x00, 0x00, 0x06, 0x40, 0x05, 0x40, 0x05, 0x40, 0x04, (byte)0xC0, 0x00, 0x00},//"s",83%/
            {0x00, 0x00, 0x04, 0x00, 0x1F, (byte)0x80, 0x04, 0x40, 0x00, 0x40, 0x00, 0x00},//"t",84%/
            {0x04, 0x00, 0x07, (byte)0x80, 0x00, 0x40, 0x04, 0x40, 0x07, (byte)0xC0, 0x00, 0x40},//"u",85%/
            {0x04, 0x00, 0x07, 0x00, 0x04, (byte)0xC0, 0x01, (byte)0x80, 0x06, 0x00, 0x04, 0x00},//"v",86%/
            {0x06, 0x00, 0x01, (byte)0xC0, 0x07, 0x00, 0x01, (byte)0xC0, 0x06, 0x00, 0x00, 0x00},//"w",87%/
            {0x04, 0x40, 0x06, (byte)0xC0, 0x01, 0x00, 0x06, (byte)0xC0, 0x04, 0x40, 0x00, 0x00},//"x",88%/
            {0x04, 0x10, 0x07, 0x10, 0x04, (byte)0xE0, 0x01, (byte)0x80, 0x06, 0x00, 0x04, 0x00},//"y",89%/
            {0x00, 0x00, 0x04, 0x40, 0x05, (byte)0xC0, 0x06, 0x40, 0x04, 0x40, 0x00, 0x00},//"z",90%/
            {0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x7B, (byte)0xE0, 0x40, 0x20, 0x00, 0x00},//"{",91%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, (byte)0xFF, (byte)0xF0, 0x00, 0x00, 0x00, 0x00},//"|",92%/
            {0x00, 0x00, 0x40, 0x20, 0x7B, (byte)0xE0, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00},//"}",93%/
            {0x40, 0x00, (byte)0x80, 0x00, 0x40, 0x00, 0x20, 0x00, 0x20, 0x00, 0x40, 0x00}//"~",94%/
    };

    private static byte[][] Font1608 = new byte[][]{
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//" ",0%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, (byte) 0xCC, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"!",1%/
            {0x00, 0x00, 0x08, 0x00, 0x30, 0x00, 0x60, 0x00, 0x08, 0x00, 0x30, 0x00, 0x60, 0x00, 0x00, 0x00},//""",2%/
            {0x02, 0x20, 0x03, (byte) 0xFC, 0x1E, 0x20, 0x02, 0x20, 0x03, (byte) 0xFC, 0x1E, 0x20, 0x02, 0x20, 0x00, 0x00},//"//",3%/
            {0x00, 0x00, 0x0E, 0x18, 0x11, 0x04, 0x3F, (byte) 0xFF, 0x10, (byte) 0x84, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00},//"$",4%/
            {0x0F, 0x00, 0x10, (byte) 0x84, 0x0F, 0x38, 0x00, (byte) 0xC0, 0x07, 0x78, 0x18, (byte) 0x84, 0x00, 0x78, 0x00, 0x00},//"%",5%/
            {0x00, 0x78, 0x0F, (byte) 0x84, 0x10, (byte) 0xC4, 0x11, 0x24, 0x0E, (byte) 0x98, 0x00, (byte) 0xE4, 0x00, (byte) 0x84, 0x00, 0x08},//"&",6%/
            {0x08, 0x00, 0x68, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"'",7%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, (byte) 0xE0, 0x18, 0x18, 0x20, 0x04, 0x40, 0x02, 0x00, 0x00},//"(",8%/
            {0x00, 0x00, 0x40, 0x02, 0x20, 0x04, 0x18, 0x18, 0x07, (byte) 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//")",9%/
            {0x02, 0x40, 0x02, 0x40, 0x01, (byte) 0x80, 0x0F, (byte) 0xF0, 0x01, (byte) 0x80, 0x02, 0x40, 0x02, 0x40, 0x00, 0x00},//"%",10%/
            {0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x0F, (byte) 0xF8, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, 0x00},//"+",11%/
            {0x00, 0x01, 0x00, 0x0D, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//",",12%/
            {0x00, 0x00, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, (byte) 0x80},//"-",13%/
            {0x00, 0x00, 0x00, 0x0C, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//".",14%/
            {0x00, 0x00, 0x00, 0x06, 0x00, 0x18, 0x00, 0x60, 0x01, (byte) 0x80, 0x06, 0x00, 0x18, 0x00, 0x20, 0x00},//"/",15%/
            {0x00, 0x00, 0x07, (byte) 0xF0, 0x08, 0x08, 0x10, 0x04, 0x10, 0x04, 0x08, 0x08, 0x07, (byte) 0xF0, 0x00, 0x00},//"0",16%/
            {0x00, 0x00, 0x08, 0x04, 0x08, 0x04, 0x1F, (byte) 0xFC, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00},//"1",17%/
            {0x00, 0x00, 0x0E, 0x0C, 0x10, 0x14, 0x10, 0x24, 0x10, 0x44, 0x11, (byte) 0x84, 0x0E, 0x0C, 0x00, 0x00},//"2",18%/
            {0x00, 0x00, 0x0C, 0x18, 0x10, 0x04, 0x11, 0x04, 0x11, 0x04, 0x12, (byte) 0x88, 0x0C, 0x70, 0x00, 0x00},//"3",19%/
            {0x00, 0x00, 0x00, (byte) 0xE0, 0x03, 0x20, 0x04, 0x24, 0x08, 0x24, 0x1F, (byte) 0xFC, 0x00, 0x24, 0x00, 0x00},//"4",20%/
            {0x00, 0x00, 0x1F, (byte) 0x98, 0x10, (byte) 0x84, 0x11, 0x04, 0x11, 0x04, 0x10, (byte) 0x88, 0x10, 0x70, 0x00, 0x00},//"5",21%/
            {0x00, 0x00, 0x07, (byte) 0xF0, 0x08, (byte) 0x88, 0x11, 0x04, 0x11, 0x04, 0x18, (byte) 0x88, 0x00, 0x70, 0x00, 0x00},//"6",22%/
            {0x00, 0x00, 0x1C, 0x00, 0x10, 0x00, 0x10, (byte) 0xFC, 0x13, 0x00, 0x1C, 0x00, 0x10, 0x00, 0x00, 0x00},//"7",23%/
            {0x00, 0x00, 0x0E, 0x38, 0x11, 0x44, 0x10, (byte) 0x84, 0x10, (byte) 0x84, 0x11, 0x44, 0x0E, 0x38, 0x00, 0x00},//"8",24%/
            {0x00, 0x00, 0x07, 0x00, 0x08, (byte) 0x8C, 0x10, 0x44, 0x10, 0x44, 0x08, (byte) 0x88, 0x07, (byte) 0xF0, 0x00, 0x00},//"9",25%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0C, 0x03, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//":",26%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//";",27%/
            {0x00, 0x00, 0x00, (byte) 0x80, 0x01, 0x40, 0x02, 0x20, 0x04, 0x10, 0x08, 0x08, 0x10, 0x04, 0x00, 0x00},//"<",28%/
            {0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x00, 0x00},//"=",29%/
            {0x00, 0x00, 0x10, 0x04, 0x08, 0x08, 0x04, 0x10, 0x02, 0x20, 0x01, 0x40, 0x00, (byte) 0x80, 0x00, 0x00},//">",30%/
            {0x00, 0x00, 0x0E, 0x00, 0x12, 0x00, 0x10, 0x0C, 0x10, 0x6C, 0x10, (byte) 0x80, 0x0F, 0x00, 0x00, 0x00},//"?",31%/
            {0x03, (byte) 0xE0, 0x0C, 0x18, 0x13, (byte) 0xE4, 0x14, 0x24, 0x17, (byte) 0xC4, 0x08, 0x28, 0x07, (byte) 0xD0, 0x00, 0x00},//"@",32%/
            {0x00, 0x04, 0x00, 0x3C, 0x03, (byte) 0xC4, 0x1C, 0x40, 0x07, 0x40, 0x00, (byte) 0xE4, 0x00, 0x1C, 0x00, 0x04},//"A",33%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x11, 0x04, 0x11, 0x04, 0x11, 0x04, 0x0E, (byte) 0x88, 0x00, 0x70, 0x00, 0x00},//"B",34%/
            {0x03, (byte) 0xE0, 0x0C, 0x18, 0x10, 0x04, 0x10, 0x04, 0x10, 0x04, 0x10, 0x08, 0x1C, 0x10, 0x00, 0x00},//"C",35%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, 0x04, 0x10, 0x04, 0x10, 0x04, 0x08, 0x08, 0x07, (byte) 0xF0, 0x00, 0x00},//"D",36%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x11, 0x04, 0x11, 0x04, 0x17, (byte) 0xC4, 0x10, 0x04, 0x08, 0x18, 0x00, 0x00},//"E",37%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x11, 0x04, 0x11, 0x00, 0x17, (byte) 0xC0, 0x10, 0x00, 0x08, 0x00, 0x00, 0x00},//"F",38%/
            {0x03, (byte) 0xE0, 0x0C, 0x18, 0x10, 0x04, 0x10, 0x04, 0x10, 0x44, 0x1C, 0x78, 0x00, 0x40, 0x00, 0x00},//"G",39%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, (byte) 0x84, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x10, (byte) 0x84, 0x1F, (byte) 0xFC, 0x10, 0x04},//"H",40%/
            {0x00, 0x00, 0x10, 0x04, 0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, 0x04, 0x10, 0x04, 0x00, 0x00, 0x00, 0x00},//"I",41%/
            {0x00, 0x03, 0x00, 0x01, 0x10, 0x01, 0x10, 0x01, 0x1F, (byte) 0xFE, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00},//"J",42%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x11, 0x04, 0x03, (byte) 0x80, 0x14, 0x64, 0x18, 0x1C, 0x10, 0x04, 0x00, 0x00},//"K",43%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x00, 0x0C, 0x00, 0x00},//"L",44%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x1F, 0x00, 0x00, (byte) 0xFC, 0x1F, 0x00, 0x1F, (byte) 0xFC, 0x10, 0x04, 0x00, 0x00},//"M",45%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x0C, 0x04, 0x03, 0x00, 0x00, (byte) 0xE0, 0x10, 0x18, 0x1F, (byte) 0xFC, 0x10, 0x00},//"N",46%/
            {0x07, (byte) 0xF0, 0x08, 0x08, 0x10, 0x04, 0x10, 0x04, 0x10, 0x04, 0x08, 0x08, 0x07, (byte) 0xF0, 0x00, 0x00},//"O",47%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, (byte) 0x84, 0x10, (byte) 0x80, 0x10, (byte) 0x80, 0x10, (byte) 0x80, 0x0F, 0x00, 0x00, 0x00},//"P",48%/
            {0x07, (byte) 0xF0, 0x08, 0x18, 0x10, 0x24, 0x10, 0x24, 0x10, 0x1C, 0x08, 0x0A, 0x07, (byte) 0xF2, 0x00, 0x00},//"Q",49%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x11, 0x04, 0x11, 0x00, 0x11, (byte) 0xC0, 0x11, 0x30, 0x0E, 0x0C, 0x00, 0x04},//"R",50%/
            {0x00, 0x00, 0x0E, 0x1C, 0x11, 0x04, 0x10, (byte) 0x84, 0x10, (byte) 0x84, 0x10, 0x44, 0x1C, 0x38, 0x00, 0x00},//"S",51%/
            {0x18, 0x00, 0x10, 0x00, 0x10, 0x04, 0x1F, (byte) 0xFC, 0x10, 0x04, 0x10, 0x00, 0x18, 0x00, 0x00, 0x00},//"T",52%/
            {0x10, 0x00, 0x1F, (byte) 0xF8, 0x10, 0x04, 0x00, 0x04, 0x00, 0x04, 0x10, 0x04, 0x1F, (byte) 0xF8, 0x10, 0x00},//"U",53%/
            {0x10, 0x00, 0x1E, 0x00, 0x11, (byte) 0xE0, 0x00, 0x1C, 0x00, 0x70, 0x13, (byte) 0x80, 0x1C, 0x00, 0x10, 0x00},//"V",54%/
            {0x1F, (byte) 0xC0, 0x10, 0x3C, 0x00, (byte) 0xE0, 0x1F, 0x00, 0x00, (byte) 0xE0, 0x10, 0x3C, 0x1F, (byte) 0xC0, 0x00, 0x00},//"W",55%/
            {0x10, 0x04, 0x18, 0x0C, 0x16, 0x34, 0x01, (byte) 0xC0, 0x01, (byte) 0xC0, 0x16, 0x34, 0x18, 0x0C, 0x10, 0x04},//"X",56%/
            {0x10, 0x00, 0x1C, 0x00, 0x13, 0x04, 0x00, (byte) 0xFC, 0x13, 0x04, 0x1C, 0x00, 0x10, 0x00, 0x00, 0x00},//"Y",57%/
            {0x08, 0x04, 0x10, 0x1C, 0x10, 0x64, 0x10, (byte) 0x84, 0x13, 0x04, 0x1C, 0x04, 0x10, 0x18, 0x00, 0x00},//"Z",58%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, (byte) 0xFE, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x00, 0x00},//"{",59%/
            {0x00, 0x00, 0x30, 0x00, 0x0C, 0x00, 0x03, (byte) 0x80, 0x00, 0x60, 0x00, 0x1C, 0x00, 0x03, 0x00, 0x00},//"\",60%/
            {0x00, 0x00, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x7F, (byte) 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"}",61%/
            {0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x20, 0x00, 0x00, 0x00},//"^",62%/
            {0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x01},//"_",63%/
            {0x00, 0x00, 0x40, 0x00, 0x40, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"`",64%/
            {0x00, 0x00, 0x00, (byte) 0x98, 0x01, 0x24, 0x01, 0x44, 0x01, 0x44, 0x01, 0x44, 0x00, (byte) 0xFC, 0x00, 0x04},//"a",65%/
            {0x10, 0x00, 0x1F, (byte) 0xFC, 0x00, (byte) 0x88, 0x01, 0x04, 0x01, 0x04, 0x00, (byte) 0x88, 0x00, 0x70, 0x00, 0x00},//"b",66%/
            {0x00, 0x00, 0x00, 0x70, 0x00, (byte) 0x88, 0x01, 0x04, 0x01, 0x04, 0x01, 0x04, 0x00, (byte) 0x88, 0x00, 0x00},//"c",67%/
            {0x00, 0x00, 0x00, 0x70, 0x00, (byte) 0x88, 0x01, 0x04, 0x01, 0x04, 0x11, 0x08, 0x1F, (byte) 0xFC, 0x00, 0x04},//"d",68%/
            {0x00, 0x00, 0x00, (byte) 0xF8, 0x01, 0x44, 0x01, 0x44, 0x01, 0x44, 0x01, 0x44, 0x00, (byte) 0xC8, 0x00, 0x00},//"e",69%/
            {0x00, 0x00, 0x01, 0x04, 0x01, 0x04, 0x0F, (byte) 0xFC, 0x11, 0x04, 0x11, 0x04, 0x11, 0x00, 0x18, 0x00},//"f",70%/
            {0x00, 0x00, 0x00, (byte) 0xD6, 0x01, 0x29, 0x01, 0x29, 0x01, 0x29, 0x01, (byte) 0xC9, 0x01, 0x06, 0x00, 0x00},//"g",71%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x00, (byte) 0x84, 0x01, 0x00, 0x01, 0x00, 0x01, 0x04, 0x00, (byte) 0xFC, 0x00, 0x04},//"h",72%/
            {0x00, 0x00, 0x01, 0x04, 0x19, 0x04, 0x19, (byte) 0xFC, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00},//"i",73%/
            {0x00, 0x00, 0x00, 0x03, 0x00, 0x01, 0x01, 0x01, 0x19, 0x01, 0x19, (byte) 0xFE, 0x00, 0x00, 0x00, 0x00},//"j",74%/
            {0x10, 0x04, 0x1F, (byte) 0xFC, 0x00, 0x24, 0x00, 0x40, 0x01, (byte) 0xB4, 0x01, 0x0C, 0x01, 0x04, 0x00, 0x00},//"k",75%/
            {0x00, 0x00, 0x10, 0x04, 0x10, 0x04, 0x1F, (byte) 0xFC, 0x00, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00},//"l",76%/
            {0x01, 0x04, 0x01, (byte) 0xFC, 0x01, 0x04, 0x01, 0x00, 0x01, (byte) 0xFC, 0x01, 0x04, 0x01, 0x00, 0x00, (byte) 0xFC},//"m",77%/
            {0x01, 0x04, 0x01, (byte) 0xFC, 0x00, (byte) 0x84, 0x01, 0x00, 0x01, 0x00, 0x01, 0x04, 0x00, (byte) 0xFC, 0x00, 0x04},//"n",78%/
            {0x00, 0x00, 0x00, (byte) 0xF8, 0x01, 0x04, 0x01, 0x04, 0x01, 0x04, 0x01, 0x04, 0x00, (byte) 0xF8, 0x00, 0x00},//"o",79%/
            {0x01, 0x01, 0x01, (byte) 0xFF, 0x00, (byte) 0x85, 0x01, 0x04, 0x01, 0x04, 0x00, (byte) 0x88, 0x00, 0x70, 0x00, 0x00},//"p",80%/
            {0x00, 0x00, 0x00, 0x70, 0x00, (byte) 0x88, 0x01, 0x04, 0x01, 0x04, 0x01, 0x05, 0x01, (byte) 0xFF, 0x00, 0x01},//"q",81%/
            {0x01, 0x04, 0x01, 0x04, 0x01, (byte) 0xFC, 0x00, (byte) 0x84, 0x01, 0x04, 0x01, 0x00, 0x01, (byte) 0x80, 0x00, 0x00},//"r",82%/
            {0x00, 0x00, 0x00, (byte) 0xCC, 0x01, 0x24, 0x01, 0x24, 0x01, 0x24, 0x01, 0x24, 0x01, (byte) 0x98, 0x00, 0x00},//"s",83%/
            {0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x07, (byte) 0xF8, 0x01, 0x04, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00},//"t",84%/
            {0x01, 0x00, 0x01, (byte) 0xF8, 0x00, 0x04, 0x00, 0x04, 0x00, 0x04, 0x01, 0x08, 0x01, (byte) 0xFC, 0x00, 0x04},//"u",85%/
            {0x01, 0x00, 0x01, (byte) 0x80, 0x01, 0x70, 0x00, 0x0C, 0x00, 0x10, 0x01, 0x60, 0x01, (byte) 0x80, 0x01, 0x00},//"v",86%/
            {0x01, (byte) 0xF0, 0x01, 0x0C, 0x00, 0x30, 0x01, (byte) 0xC0, 0x00, 0x30, 0x01, 0x0C, 0x01, (byte) 0xF0, 0x01, 0x00},//"w",87%/
            {0x00, 0x00, 0x01, 0x04, 0x01, (byte) 0x8C, 0x00, 0x74, 0x01, 0x70, 0x01, (byte) 0x8C, 0x01, 0x04, 0x00, 0x00},//"x",88%/
            {0x01, 0x01, 0x01, (byte) 0x81, 0x01, 0x71, 0x00, 0x0E, 0x00, 0x18, 0x01, 0x60, 0x01, (byte) 0x80, 0x01, 0x00},//"y",89%/
            {0x00, 0x00, 0x01, (byte) 0x84, 0x01, 0x0C, 0x01, 0x34, 0x01, 0x44, 0x01, (byte) 0x84, 0x01, 0x0C, 0x00, 0x00},//"z",90%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x3E, (byte) 0xFC, 0x40, 0x02, 0x40, 0x02},//"{",91%/
            {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, (byte) 0xFF, (byte) 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"|",92%/
            {0x00, 0x00, 0x40, 0x02, 0x40, 0x02, 0x3E, (byte) 0xFC, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},//"}",93%/
            {0x00, 0x00, 0x60, 0x00, (byte) 0x80, 0x00, (byte) 0x80, 0x00, 0x40, 0x00, 0x40, 0x00, 0x20, 0x00, 0x20, 0x00}//"~",94%/
    };

    private static byte[] progress_head = new byte[] {
            0x00,0x00,0x00,0x00,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC};
    private static byte[] progress_zero = new byte[] {
            0x00,0x00,0x00,0x00,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,
            0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,
            };
    private static byte[] progress_start = new byte[] {
            0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,
            0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,
            };
    private static byte[] progress_Spare = new byte[] {
            0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,
            0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC
            };
    private static byte[] progress_full = new byte[] {
            0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,
            0x30,0x0C,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x00,0x00,0x00,0x00,
            };
    private static byte[] progress_end = new byte[] {
            0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,
            0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x3F,(byte)0xFC,0x00,0x00,0x00,0x00,
            };

    public EPAPER(PeripheralManagerService service)
    {
        this.service = service;
        try {
          //  List<String> spibus =  service.getSpiBusList();
            //List<String> gpiolist =  service.getGpioList();
            RST = service.openGpio("BCM17");
            DC = service.openGpio("BCM25");
            BUSY = service.openGpio("BCM24");
            DC.setDirection(Gpio.DIRECTION_OUT_INITIALLY_LOW);
            DC.setActiveType(Gpio.ACTIVE_HIGH);
            RST.setDirection(Gpio.DIRECTION_OUT_INITIALLY_HIGH);
            RST.setActiveType(Gpio.ACTIVE_HIGH);
            BUSY.setDirection(Gpio.DIRECTION_IN);
            BUSY.setActiveType(Gpio.ACTIVE_HIGH);
            while(device == null)
            {
                device = getDevice();
            }
            bitmapImage();
        } catch (IOException e) {
            e.printStackTrace();
        }


    }

    private void bitmapImage()
    {
        paint = new Paint(Paint.ANTI_ALIAS_FLAG);
        paint.setColor(Color.BLACK);
        image = Bitmap.createBitmap(128, 296, Bitmap.Config.ARGB_8888);
        matrix = new Matrix();
        matrix.postScale(-1, 1, image.getWidth() / 2, image.getHeight() / 2);
        canvas = new Canvas(image);
        canvas.drawColor(Color.WHITE);



    }

    private SpiDevice getDevice()
    {
        try {
            SpiDevice dev = service.openSpiDevice("SPI0.0");
            dev.setMode(SpiDevice.MODE0);
            dev.setFrequency(2000000);
            dev.setBitsPerWord(8);
            Thread.sleep(DELAYTIME);
            return dev;
        } catch (IOException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return null;
    }

    private void resetAll()
    {

        try {
            RST.setValue(false);
            sleep();

            if (RST.getValue() == false)
            {
                Log.d("SYSTEM MESSAGE", "RESET COMPLETE");
            }
            else
            {
                Log.d("SYSTEM MESSAGE", "RESET FAILED");
            }
            RST.setValue(true);
            sleep();
            //set register
            Log.d("SYSTEM MESSAGE", "SET REGISTER");
            write(GDOControl); //panel config
            write(softstart); //x+ y-
            write(VCOMVol); //vcom set
            write(DummyLine); // dummy line per gate
            write(Gatetime); // gate time setting
            write(RamDataEntryMode); //x+ y-
            setRamArea(0x00,(xDot-1)/8,(yDot-1)%256,(yDot-1)/256,0x00,0x00);
            setRamPointer((byte)0x00,(byte)((yDot-1)%256),(byte)((yDot-1)/256));
            Log.d("SYSTEM MESSAGE", "SET REGISTER END");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private boolean readBusy()
    {
        try {
            for (int i = 0; i < 400; i++) {
                if (BUSY.getValue() == false) {
                    Log.d("SYS MESSAGE", "continue");
                    return true;
                }
                else
                {
                    Log.d("SYS MESSAGE", "busy");
           }
                Thread.sleep(DELAYTIME);
            }
        } catch (IOException e) {
            e.printStackTrace();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return false;
    }

    private void writeCMD(byte command)
    {
        try {
            DC.setValue(false);
            byte[] buffer = new byte[]{command};
            device.write(buffer, buffer.length);
            Log.d("WRITECMD", String.valueOf(buffer[0]));
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void writeCMD_pl(byte command, byte para)
    {
        try {
            readBusy();
            DC.setValue(false);
            byte[] buffer = new byte[]{command};
            device.write(buffer, buffer.length);
            Log.d("WRITECMDPL", String.valueOf(buffer[0]));
            DC.setValue(true);
            buffer = new byte[]{para};
            device.write(buffer, buffer.length);
            Log.d("WRITECMDPL", String.valueOf(buffer[0]));
        } catch (IOException e) {
            e.printStackTrace();
        }

    }

    private void powerOn()
    {
        writeCMD_pl((byte)0x22, (byte)0xc0);
        writeCMD((byte)0x20);
    }

    private void write(byte[] value)
    {
        try {
            DC.setValue(false);
            byte[] buffer = new byte[]{value[0]};
            device.write(buffer, buffer.length);
            Log.d("WRITE", String.valueOf(buffer[0]));
            DC.setValue(true);

            buffer = new byte[value.length-1];
            for (int i=0; i< value.length-1; i++ )
            {
            buffer[i] =value[i+1];
                Log.d("WRITE", String.valueOf(buffer[i]));
            }

            device.write(buffer, buffer.length);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private void writeDispRam(int xSize, int ySize, byte[] dispBuff, int xStart, int xEnd, int yStart, int yEnd)
    {
        if ((xSize%8) != 0)
        {
            xSize = xSize+(8-xSize%8);
        }

        xSize = xSize/8;

        int num = 0;
        readBusy();
        try {
            DC.setValue(false);
            byte[] buffer = new byte[]{(byte)0x24};
            device.write(buffer, buffer.length);
            Log.d("WRITERAM", String.valueOf(buffer[0]));
            DC.setValue(true);
            for (int i=0; i< xSize; i++)
            {
                for (int ii=0; ii< ySize; ii++)
                {
                            buffer = new byte[]{dispBuff[num]};
                            device.write(buffer, buffer.length);
                            num++;
                }
            }

    } catch (IOException e1) {
            e1.printStackTrace();
        }
    }

    private void writeDispRamMono(int xSize, int ySize, byte[] dispBuff, int xStart, int xEnd, int yStart, int yEnd)
    {
        if ((xSize%8) != 0)
        {
            xSize = xSize+(8-xSize%8);
        }
        readBusy();
        try {
            DC.setValue(false);
            byte[] buffer = new byte[]{(byte)0x24};
            device.write(buffer, buffer.length);
            Log.d("WRITEMONO", String.valueOf(buffer[0]));
            DC.setValue(true);
            device.write(dispBuff, dispBuff.length);
                    } catch (IOException e) {
            e.printStackTrace();
        }

    }

    private void setRamArea(int xStart, int xEnd, int yStart, int yStart1, int yEnd, int yEnd1)
    {
        byte[] ramAreaX = new byte[3];
        ramAreaX[0] = (byte)0x44;
        ramAreaX[1] = (byte)xStart;
        ramAreaX[2] = (byte)xEnd;
        byte[] ramAreaY = new byte[5];
        ramAreaY[0] = (byte)0x45;
        ramAreaY[1] = (byte)yStart;
        ramAreaY[2] = (byte)yStart1;
        ramAreaY[3] = (byte) yEnd;
        ramAreaY[4] = (byte) yEnd1;

        write(ramAreaX);
        write(ramAreaY);
    }

    private void setRamPointer(int addrX, int addrY, int addrY1)
    {
        byte[] ramPointerX = new byte[2];
        ramPointerX[0] = (byte)0x4e;
        ramPointerX[1] = (byte)addrX;
        byte[] ramPointerY = new byte[3];
        ramPointerY[0] = (byte)0x4f;
        ramPointerY[1] = (byte)addrY;
        ramPointerY[2] =(byte) addrY1;

        write(ramPointerX);
        write(ramPointerY);
    }

    private void partDisplay(int ramXST,int ramXEND,int ramYST,int ramYST1,int ramYEND,int ramYEND1)
    {
        setRamArea(ramXST, ramXEND, ramYST, ramYST1, ramYEND, ramYEND1);
        setRamPointer(ramXST, ramYST, ramYST1);
    }

    private void update()
    {
        writeCMD_pl((byte)0x22, (byte)0xc7);
        writeCMD((byte)0x20);
        writeCMD((byte)0xff);
    }

    private void updatePart()
    {
        writeCMD_pl((byte)0x22, (byte)0x04);
        writeCMD((byte)0x20);
        writeCMD((byte)0xff);
    }

    private void epdFull()
    {
        resetAll();
        write(LUTDefault_full);
        powerOn();
    }

    private void epdPart()
    {
        resetAll();
        write(LUTDefault_part);
        powerOn();
    }

    private void dispFull(byte[] dispBuffer, int label)
    {
        setRamPointer(0,((yDot-1)%256),((yDot-1)/256));

        if (label ==0)
        {

            writeDispRamMono(xDot, yDot, dispBuffer, 0, xDot, 0, yDot);
        }
        else
        {
            writeDispRam(xDot, yDot, dispBuffer, 0, xDot, 0, yDot);
        }
        update();
    }

    private void dispPart(int xStart, int xEnd, int yStart, int yEnd, byte[] dispBuffer, int label)
    {
        if (label ==0)
        {
            partDisplay((xStart/8),(xEnd/8),(yEnd%256),(yEnd/256),(yStart%256),(yStart/256));
            byte[] buffer = new byte[]{dispBuffer[0]};
            writeDispRamMono(xEnd-xStart, yEnd-yStart+1, buffer, xStart, xEnd, yStart, yEnd);
            sleep();
            partDisplay((xStart/8),(xEnd/8),(yEnd%256),(yEnd/256),(yStart%256),(yStart/256));
            writeDispRamMono(xEnd-xStart, yEnd-yStart+1, buffer, xStart, xEnd, yStart, yEnd);
        }
        else
        {
            partDisplay((xStart/8),(xEnd/8),(yEnd%256),(yEnd/256),(yStart%256),(yStart/256));
            writeDispRam(xEnd-xStart, yEnd-yStart+1, dispBuffer, xStart, xEnd, yStart, yEnd);
            updatePart();
            sleep();
            partDisplay((xStart/8),(xEnd/8),(yEnd%256),(yEnd/256),(yStart%256),(yStart/256));
            writeDispRam(xEnd-xStart, yEnd-yStart+1, dispBuffer, xStart, xEnd, yStart, yEnd);
        }
    }


    // public app layer

    //clear full screen

    public void dispClearFull()
    {
        Log.d("DISPLAY UPDATE", "CLEAR");
        epdFull();
        sleep();
        byte[] buffer = new byte[]{(byte)0xff};
        dispFull(buffer, 0);
        sleep();
    }

    public void dispClearPart()
    {
        Log.d("DISPLAY UPDATE", "CLEAR PART");
        epdPart();
        try {
            Thread.sleep(DELAYTIME);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        byte[] buffer = new byte[]{(byte)0xff};
        dispPart(0,xDot-1,0,yDot-1,buffer,0);
        try {
            Thread.sleep(DELAYTIME);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    public void dispClearFullPic(byte[] dispBuffer)
    {
        dispFull(dispBuffer, 1);
    }

    public void dispClearPartPic(int xStart, int xEnd, int yStart, int yEnd, byte dispBuffer)
    {
        byte[] buffer = new byte[]{dispBuffer};
        dispPart(xStart,xEnd,yStart,yEnd, buffer,1);
    }

    // character size
    public void dispCharSize(char data, char size, char mode, char next)
    {

    }

    // write string to disp
    public void dispWriteString(int x, int y, String input, int size)
    {
        canvas.drawText(input,x,y, paint);
        canvas.drawBitmap(image, matrix, paint);
        int arraySize = image.getByteCount();
        int[] pixels = new int[arraySize];
        image.getPixels(pixels, 0, image.getWidth(), 0, 0, image.getWidth(), image.getHeight());
        dispFull(imageConvert(pixels),1);
    }


    public byte[] imageConvert(int[] input)
    {

        byte[] convert = new byte[(input.length)/8];

        int count =0;

        String bin = "";

        for (int i=0; i< input.length/8; i++)
        {
            for (int ii=0; ii< 8; ii++)
            {
                if (input[count] == -1)
                {
                    bin = bin+ "1";
                }
                else
                {
                    bin = bin+ "0";
                }
                count++;
            }
            int conv = Integer.valueOf(bin,2);
            convert[i] = (byte) conv;
            bin = "";
        }
        return convert;

    }
    // draw picture
    public void dispDrawPicture(int x, int y, Bitmap input, int xSize, int ySize)
    {
        canvas.drawBitmap(input, matrix, paint);
        int arraySize = input.getByteCount();
        int[] pixels = new int[arraySize];
        image.getPixels(pixels, 0, image.getWidth(), 0, 0, image.getWidth(), image.getHeight());
        dispFull(imageConvert(pixels),1);
    }

    public void dispDrawPartPicture(int x, int y, Bitmap input, int xSize, int ySize)
    {
        Bitmap pImage = Bitmap.createBitmap(xSize, ySize, Bitmap.Config.ARGB_8888);
        Canvas pCanvas = new Canvas(pImage);
        pCanvas.drawColor(Color.WHITE);
        pCanvas.drawBitmap(input, matrix, paint);
        int arraySize = input.getByteCount();
        int[] pixels = new int[arraySize];
        pImage.getPixels(pixels, 0, pImage.getWidth(), 0, 0, pImage.getWidth(), pImage.getHeight());
        //dispFull(imageConvert(pixels),1);
        dispPart(x, (x+pImage.getWidth()), y, (y+pImage.getHeight()), imageConvert(pixels), 1);
    }

    //show progress
    public void dispProgress(int length)
    {

    }
    public void dispShowTime(int xStart, int yStart, int hour, int minute, int sec)
    {

    }

    public void sleep()
    {
        try {
            Thread.sleep(DELAYTIME);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
